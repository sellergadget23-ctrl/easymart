<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ShopPlus</title>

  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <!-- EmailJS -->
  <script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>
  <script>
    (function(){ emailjs.init("1MH2OPgPAqXqD8FiV"); })();  // ‚úÖ Your Public Key
  </script>

  <!-- Styles -->
  <link rel="stylesheet" href="style.css">
<header>
  <div class="header-top">
    <div class="logo">
      <img src="shopplus.gif" alt="shopplus.gif" loading="lazy">
      <h1>ShopPlus</h1>
    </div>

    <!-- Mobile menu toggle -->
    <input type="checkbox" id="navToggle" class="nav-toggle">
    <label for="navToggle" class="nav-toggle-label">
      <span></span>
    </label>

    <nav>
      <ul>
        <li><a href="#shop" data-key="navShop">Shop</a></li>
        <li><a href="#cart" data-key="navCart">Cart</a></li>
        <li><a href="#checkout" data-key="navCheckout">Checkout</a></li>
      </ul>
    </nav>

    <div class="controls">
      <label for="language">Language:</label>
      <select id="language">
        <option value="en">English</option>
        <option value="th">Thai</option>
        <option value="ph">Filipino</option>
      </select>

      <label for="currency">Currency:</label>
      <select id="currency">
        <option value="USD">USD</option>
        <option value="THB">THB</option>
        <option value="PHP" selected>PHP</option>
      </select>

      <div class="cart-count">üõí <span id="cartCount">0</span></div>
    </div>
  </div>
</header>
          

  <!-- Main Content -->
  <main>
    <!-- Shop -->
    <section id="shop">
      <div class="filters">
        <label>Category: 
          <select id="categoryFilter">
            <option value="all">All</option>
          </select>
        </label>
      </div>
      <div id="productGrid"></div>
    </section>

    <!-- Cart -->
    <section id="cart">
      <h2 data-key="cartHeading">Your Cart</h2>
      <table id="cartTable">
        <thead>
          <tr>
            <th data-key="product">Product</th>
            <th data-key="qty">Qty</th>
            <th data-key="price">Price</th>
            <th data-key="total">Total</th>
            <th data-key="remove">Remove</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
      <h3 id="cartTotal">Total: ‚Ç±0</h3>
    </section>

    <!-- Checkout -->
    <section id="checkout">
      <form id="checkoutForm" class="hidden checkout-form">
        <h3>Checkout</h3>

        <input type="text" id="name" placeholder="Your Name" required>
        <input type="email" id="email" placeholder="Your Email" required>
        <input type="tel" id="phone" placeholder="Phone Number" required>
        <input type="text" id="address" placeholder="Delivery Address" required>

        <label for="paymentMethod">Payment Method:</label>
        <select id="paymentMethod">
          <option value="Bank Transfer">Bank Transfer</option>
          <option value="Partial Payment Transfer">Partial Payment Transfer</option>
          <option value="Cash on Delivery">Cash on Delivery</option>
          <option value="Card Payment (coming soon)">Card Payment (coming soon)</option>
        </select>

        <button type="submit">Place Order</button>
      </form>

      <!-- Success Message -->
      <div id="successMessage" class="hidden success-message">
        ‚úÖ Your order has been placed successfully! We‚Äôll contact you soon.
      </div>

      <!-- Error Message -->
      <div id="errorMessage" class="hidden error-message">
        ‚ùå Failed to place order. Please try again.
      </div>
    </section>

    <!-- Reviews -->
    <section id="siteReviews">
      <h3 data-key="reviewsHeading">Customer Reviews</h3>
      <div id="siteAvgStars"></div>
      <div id="siteAvgText"></div>
      <div id="siteReviewsList"></div>

      <form id="siteReviewForm">
        <label>Rating:
          <select name="rating" required>
            <option value="5">‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ</option>
            <option value="4">‚òÖ‚òÖ‚òÖ‚òÖ‚òÜ</option>
            <option value="3">‚òÖ‚òÖ‚òÖ‚òÜ‚òÜ</option>
            <option value="2">‚òÖ‚òÖ‚òÜ‚òÜ‚òÜ</option>
            <option value="1">‚òÖ‚òÜ‚òÜ‚òÜ‚òÜ</option>
          </select>
        </label>
        <input type="text" name="name" placeholder="Your name" required>
        <textarea name="comment" placeholder="Write your comment (optional)"></textarea>
        <button type="submit" data-key="submitReview">Submit Review</button>
      </form>
    </section>

    <!-- Admin Panel (Hidden unless Admin) -->
    <section id="adminPanel" class="hidden">
      <h2>Admin Panel</h2>
      <form id="productForm">
        <input type="text" id="prodName" placeholder="Product Name" required>
        <input type="number" id="prodPrice" placeholder="Price (USD)" required>
        <input type="text" id="prodCategory" placeholder="Category" required>
        <textarea id="prodDesc" placeholder="Description"></textarea>
        <button type="submit">Add Product</button>
      </form>
      <div id="adminProducts"></div>
    </section>
  </main>

  <!-- Footer -->
  <footer>
    <p>&copy; 2025 Brightgrid Wiring Co</p>
  </footer>



<script>
/* ==============================
   Utilities
============================== */
function safeParse(json, fallback){ try { return JSON.parse(json) || fallback; } catch(e){ return fallback; } }
function getJSON(key, fallback){ return safeParse(localStorage.getItem(key), fallback); }
function setJSON(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

/* ==============================
   Language & Currency
============================== */
const translations = {
  en:{ navShop:"Shop", navCart:"Cart", navCheckout:"Checkout",
    cartHeading:"Your Cart", checkoutHeading:"Checkout", placeOrder:"Place Order",
    reviewsHeading:"Customer Reviews", submitReview:"Submit Review", noReviews:"No reviews yet.",
    name:"Your Name", email:"Your Email", phone:"Phone Number", address:"Delivery Address",
    paymentMethod:"Payment Method", bankTransfer:"Bank Transfer", partialPayment:"Partial Payment",
    rating:"Rating", all:"All", total:"Total", average:"Average", comment:"Write your comment (optional)"
  },
  th:{ navShop:"‡∏£‡πâ‡∏≤‡∏ô‡∏Ñ‡πâ‡∏≤", navCart:"‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤", navCheckout:"‡πÄ‡∏ä‡πá‡∏Ñ‡πÄ‡∏≠‡∏≤‡∏ó‡πå",
    cartHeading:"‡∏ï‡∏∞‡∏Å‡∏£‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì", checkoutHeading:"‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô", placeOrder:"‡∏™‡∏±‡πà‡∏á‡∏ã‡∏∑‡πâ‡∏≠",
    reviewsHeading:"‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏à‡∏≤‡∏Å‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤", submitReview:"‡∏™‡πà‡∏á‡∏£‡∏µ‡∏ß‡∏¥‡∏ß", noReviews:"‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏µ‡∏ß‡∏¥‡∏ß",
    name:"‡∏ä‡∏∑‡πà‡∏≠‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì", email:"‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì", phone:"‡πÄ‡∏ö‡∏≠‡∏£‡πå‡πÇ‡∏ó‡∏£", address:"‡∏ó‡∏µ‡πà‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏±‡∏î‡∏™‡πà‡∏á",
    paymentMethod:"‡∏ß‡∏¥‡∏ò‡∏µ‡∏Å‡∏≤‡∏£‡∏ä‡∏≥‡∏£‡∏∞‡πÄ‡∏á‡∏¥‡∏ô", bankTransfer:"‡πÇ‡∏≠‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏ò‡∏ô‡∏≤‡∏Ñ‡∏≤‡∏£", partialPayment:"‡∏ä‡∏≥‡∏£‡∏∞‡∏ö‡∏≤‡∏á‡∏™‡πà‡∏ß‡∏ô",
    rating:"‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô", all:"‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î", total:"‡∏£‡∏≤‡∏Ñ‡∏≤‡∏£‡∏ß‡∏°", average:"‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢", comment:"‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏¥‡∏î‡πÄ‡∏´‡πá‡∏ô‡∏Ç‡∏≠‡∏á‡∏Ñ‡∏∏‡∏ì (‡πÑ‡∏°‡πà‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô)"
  },
  ph:{ navShop:"Tindahan", navCart:"Cart", navCheckout:"Checkout",
    cartHeading:"Ang Iyong Cart", checkoutHeading:"Checkout", placeOrder:"Ilagay ang Order",
    reviewsHeading:"Mga review mula sa mga customer", submitReview:"Isumite ang Review", noReviews:"Walang review pa.",
    name:"Pangalan mo", email:"Email mo", phone:"Telepono", address:"Address sa Pag-deliver",
    paymentMethod:"Paraan ng Pagbabayad", bankTransfer:"Bank Transfer", partialPayment:"Partial Payment",
    rating:"Rating", all:"Lahat", total:"Kabuuan", average:"Karaniwan", comment:"Isulat ang komento mo (opsyonal)"
  }
};

let currentLanguage = localStorage.getItem("language") || "en";
let currentCurrency = localStorage.getItem("currency") || "PHP"; // default PHP

function t(key){ return translations[currentLanguage][key] || translations.en[key] || key; }

function setLanguage(lang){
  currentLanguage = lang;
  localStorage.setItem("language", lang);
  // Translate all elements with data-key
  document.querySelectorAll("[data-key]").forEach(el => el.textContent = t(el.dataset.key));
  // Update dynamic UI bits
  populateCategories();
  updateCheckoutPlaceholders();
  updateReviewPlaceholders();
  updatePrices();
  renderSiteReviews();
}

/* ==============================
   Firebase Initialization
============================== */
const firebaseConfig = {
  apiKey: "AIzaSyBaHYwRvQpEn9LsY7-uV51hVn-ixHzQP4",
  authDomain: "shopplus-e-commerce.firebaseapp.com",
  projectId: "shopplus-e-commerce",
  storageBucket: "shopplus-e-commerce.appspot.com",
  messagingSenderId: "1028340895006",
  appId: "1:1028340895006:web:3218487a7bc23eb0db8d0f",
  measurementId: "G-GZEZ7X2HYR"
};

if (typeof firebase === "undefined") {
  console.error("Firebase SDK not loaded.");
}
else {
  firebase.initializeApp(firebaseConfig);
}
const db = typeof firebase !== "undefined" ? firebase.firestore() : null;
const auth = typeof firebase !== "undefined" ? firebase.auth() : null;

/* ==============================
   Admin Detection
============================== */
let adminMode = false;
if (auth) {
  auth.onAuthStateChanged(user => {
    adminMode = user?.uid === "U1DBTrFLE4UzMeFfIIvtzz3Sokp1" || false;
    // ‚úÖ Products will refresh automatically via onSnapshot
    // so no need to call fetchProducts() multiple times.
  });
}

/* ==============================
   Products (Firestore)
============================== */
let products = [];
let unsubscribeProducts = null; // ‚úÖ prevent multiple onSnapshot listeners

function fetchProducts(){
  if(!db){ 
    console.warn("No Firestore instance. Skipping fetchProducts."); 
    return; 
  }

  // ‚úÖ Detach previous snapshot listener to avoid duplicates
  if (unsubscribeProducts) unsubscribeProducts();

  try {
    unsubscribeProducts = db.collection("products").onSnapshot(snapshot => {
      products = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
      populateCategories();
      const selected = document.getElementById("categoryFilter")?.value || "all";
      renderProducts(selected, adminMode);
    });
  } catch(err) {
    console.error("Failed to fetch products:", err);
  }
}

function populateCategories(){
  const catSel = document.getElementById("categoryFilter");
  if(!catSel) return;
  const categories = ["all", ...new Set(products.map(p => p.category).filter(Boolean))];
  catSel.innerHTML = categories.map(c => `<option value="${c}">${t(c) || c}</option>`).join("");
}

function getStars(rating){
  const full = Math.floor(rating || 0);
  const half = (rating - full) >= 0.5 ? 1 : 0;
  const empty = 5 - full - half;
  return "‚òÖ".repeat(full) + (half ? "‚Ø™" : "") + "‚òÜ".repeat(empty);
}

async function renderProducts(category="all", admin=false){
  const grid = document.getElementById("productGrid");
  if(!grid) return;

  // ‚úÖ Clear grid before re-render
  grid.innerHTML = "";

  const filtered = category === "all" ? products : products.filter(p => p.category === category);

  for(const p of filtered){
    const card = document.createElement("div");
    card.className = "product";

    // Compute average rating
    let avgRating = p.rating || 0;
    try {
      if(db){
        const snapshot = await db.collection("products").doc(p.id).collection("reviews").get();
        if(!snapshot.empty){
          const reviews = snapshot.docs.map(d => d.data());
          avgRating = reviews.reduce((s, r) => s + (r.rating || 0), 0) / reviews.length;
          avgRating = Math.min(5, avgRating); // removed random bias to avoid inconsistency
        }
      }
    } catch(e){ console.error(e); }

    const stars = getStars(avgRating);

    card.innerHTML = `
      <img src="${p.imageUrl || p.image || ""}" alt="${p.name || ""}" loading="lazy">
      <h3>${p.name || ""}</h3>
      <p class="price" data-usd="${p.price || 0}">
        ${Number(p.price || 0).toLocaleString("en",{style:"currency",currency:"USD"})}
      </p>
      <p class="rating" style="color:gold;">${stars}</p>
      <button onclick="addToCart('${p.id}','${(p.name||"").replace(/'/g,"\\'")}',${p.price || 0})">${t('placeOrder')}</button>
      ${admin ? `
        <button onclick="editProductPrompt('${p.id}')">Edit</button>
        <button onclick="deleteProduct('${p.id}')">Delete</button>
      ` : ""}
      <div id="reviews-${p.id}" class="productReviews"></div>
    `;

    grid.appendChild(card);

    // ‚úÖ Render product reviews safely (make sure it clears old content inside)
    renderProductReviews(p.id, admin);
  }

  updatePrices();
}


  
/* ==============================
   Admin Product Functions
============================== */
async function addProduct(name, price, imageUrl, category, rating=0){
  try{
    await db.collection("products").add({ name, price, imageUrl, category, rating });
    alert("Product added!");
  }catch(err){ console.error(err); alert("Failed to add product"); }
}

async function editProduct(id, updatedData){
  try{
    await db.collection("products").doc(id).update(updatedData);
    alert("Product updated!");
  }catch(err){ console.error(err); alert("Failed to edit product"); }
}

async function deleteProduct(id){
  if(!confirm("Delete this product?")) return;
  try{
    await db.collection("products").doc(id).delete();
    alert("Deleted.");
  }catch(err){ console.error(err); alert("Failed to delete"); }
}

function editProductPrompt(id){
  const p = products.find(x => x.id === id) || {};
  const name = prompt("Name:", p.name || "");
  const price = parseFloat(prompt("Price:", p.price ?? 0));
  const imageUrl = prompt("Image URL:", p.imageUrl || p.image || "");
  const category = prompt("Category:", p.category || "");
  const rating = parseInt(prompt("Rating (0-5):", p.rating || 0), 10);
  if(name && !isNaN(price) && imageUrl && category && !isNaN(rating)){
    editProduct(id, { name, price, imageUrl, category, rating });
  }
}

/* ==============================
   Product Reviews (subcollection)
============================== */
async function renderProductReviews(productId, admin=false){
  try{
    const container = document.getElementById(`reviews-${productId}`);
    if(!container || !db) return;
    container.innerHTML = "";

    const snapshot = await db.collection("products").doc(productId).collection("reviews").orderBy("createdAt","desc").get();
    const reviews = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));

    if(reviews.length){
      const avg = reviews.reduce((s, r) => s + (r.rating || 0), 0) / reviews.length;
      const avgDiv = document.createElement("div");
      avgDiv.innerHTML = `<strong>${t('average')}:</strong> <span style="color:gold;">${'‚òÖ'.repeat(Math.round(avg))}${'‚òÜ'.repeat(5 - Math.round(avg))}</span>`;
      container.appendChild(avgDiv);

      reviews.forEach(r=>{
        const div = document.createElement("div");
        div.className = "reviewItem";
        div.innerHTML = `
          <strong>${r.name || "Anonymous"}</strong>
          <span style="color:gold;">${'‚òÖ'.repeat(r.rating||0)}${'‚òÜ'.repeat(5 - (r.rating||0))}</span>
          <p>${r.comment || ""}</p>
        `;
        if(admin){
          const editBtn = document.createElement("button");
          editBtn.textContent = "Edit";
          editBtn.onclick = () => editReviewPrompt(productId, r.id, r);
          const delBtn = document.createElement("button");
          delBtn.textContent = "Delete";
          delBtn.onclick = () => deleteReview(productId, r.id);
          div.appendChild(editBtn);
          div.appendChild(delBtn);
        }
        container.appendChild(div);
      });
    }
  }catch(err){
    console.error(err);
  }
}

// Optional stubs to avoid reference errors when admin clicks
function editReviewPrompt(productId, reviewId, data){ alert("Edit review not implemented in this file."); }
function deleteReview(productId, reviewId){ alert("Delete review not implemented in this file."); }

/* ==============================
   Site-wide Reviews (localStorage)
============================== */
let siteReviews = getJSON("siteReviews", []);

function updateReviewPlaceholders(){
  const f = document.getElementById("siteReviewForm");
  if(!f) return;
  const name = f.querySelector('input[name="name"]');
  const comment = f.querySelector('textarea[name="comment"]');
  if(name) name.placeholder = t('name');
  if(comment) comment.placeholder = t('comment');
}

function renderSiteReviews(){
  const list = document.getElementById("siteReviewsList");
  const avgStars = document.getElementById("siteAvgStars");
  const avgText = document.getElementById("siteAvgText");
  if(!list) return;

  list.innerHTML = "";
  if(!siteReviews.length){
    list.innerHTML = `<p>${t('noReviews')}</p>`;
    if(avgStars) avgStars.textContent = "";
    if(avgText)  avgText.textContent = "";
    return;
  }

  const avg = siteReviews.reduce((s,r)=> s + parseInt(r.rating,10), 0) / siteReviews.length;
  if(avgStars) avgStars.textContent = '‚òÖ'.repeat(Math.round(avg)) + '‚òÜ'.repeat(5 - Math.round(avg));
  if(avgText)  avgText.textContent  = `${t('average')}: ${avg.toFixed(1)}`;

  siteReviews.forEach(r=>{
    const div = document.createElement("div");
    div.innerHTML = `<strong>${r.name}</strong> ${'‚òÖ'.repeat(r.rating)}<p>${r.comment || ""}</p>`;
    list.appendChild(div);
  });
}

/* ==============================
   Cart & Currency
============================== */
const rates = { USD: 1, THB: 36, PHP: 55 };
let firstScrollDone = false;

function getCart(){ return JSON.parse(localStorage.getItem("cartItems") || "[]"); }
function setCart(cart){ localStorage.setItem("cartItems", JSON.stringify(cart)); }

// Add to Cart
function addToCart(id, name, price){
  const cart = getCart();
  const item = cart.find(i => i.id === id);
  if(item) item.quantity++;
  else cart.push({ id, name, price, quantity: 1 });
  setCart(cart);
  updateCart();
  alert(`${name} added to cart!`);

  const checkoutForm = document.getElementById("checkoutForm");
  if(checkoutForm){
    checkoutForm.classList.remove("hidden");
    if(!firstScrollDone){
      checkoutForm.scrollIntoView({ behavior: "smooth" });
      firstScrollDone = true;
    }
  }
}

// Remove from Cart
function removeFromCart(id){
  setCart(getCart().filter(i => i.id !== id));
  updateCart();
}

// Update Cart Table & Totals
function updateCart(){
  const tbody = document.querySelector("#cartTable tbody");
  if(tbody){
    tbody.innerHTML = "";
    const cart = getCart();

    cart.forEach(item=>{
      const itemTotal = item.price * item.quantity;
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${item.name}</td>
        <td>
          <button class="qty-btn" data-id="${item.id}" data-action="decrease">‚Äì</button>
          <input type="number" min="1" value="${item.quantity}" class="cart-qty" data-id="${item.id}">
          <button class="qty-btn" data-id="${item.id}" data-action="increase">+</button>
        </td>
        <td data-usd="${item.price}"></td>
        <td data-usd="${itemTotal}"></td>
        <td><button onclick="removeFromCart('${item.id}')">X</button></td>
      `;
      tbody.appendChild(tr);
    });

    const countEl = document.getElementById("cartCount");
    if(countEl) countEl.textContent = cart.reduce((s,i)=>s+i.quantity,0);

    bindQuantityInputs();
    bindQtyButtons();
  }

  updatePrices();

  const checkoutForm = document.getElementById("checkoutForm");
  if(checkoutForm && !getCart().length){
    checkoutForm.classList.add("hidden");
    firstScrollDone = false;
  }
}

// Quantity input binding
function bindQuantityInputs(){
  document.querySelectorAll(".cart-qty").forEach(input=>{
    input.oninput = () => {
      const id = input.dataset.id;
      let qty = parseInt(input.value,10);
      if(isNaN(qty) || qty < 1) qty = 1;
      input.value = qty;

      const cart = getCart();
      const item = cart.find(i => i.id === id);
      if(item) item.quantity = qty;
      setCart(cart);
      updateCart();
    };
  });
}

// +/- buttons
function bindQtyButtons(){
  document.querySelectorAll(".qty-btn").forEach(btn=>{
    btn.onclick = () => {
      const id = btn.dataset.id;
      const action = btn.dataset.action;
      const cart = getCart();
      const item = cart.find(i => i.id === id);
      if(!item) return;
      if(action === "increase") item.quantity++;
      if(action === "decrease" && item.quantity > 1) item.quantity--;
      setCart(cart);
      updateCart();
    };
  });
}

// Prices & display currency
function updatePrices(){
  document.querySelectorAll("[data-usd]").forEach(el=>{
    const usd = parseFloat(el.dataset.usd || "0");
    const cur = rates[currentCurrency] ? currentCurrency : "USD";
    el.textContent = (usd * rates[cur]).toLocaleString("en", { style:"currency", currency: cur });
  });

  const totalEl = document.getElementById("cartTotal");
  if(totalEl){
    const cur = rates[currentCurrency] ? currentCurrency : "USD";
    const total = getCart().reduce((s,i)=> s + i.price*i.quantity, 0) * rates[cur];
    totalEl.textContent = `${t('total')}: ${total.toLocaleString("en",{style:"currency",currency:cur})}`;
  }
}

function setCurrency(cur){
  if(!rates[cur]) return;
  currentCurrency = cur;
  localStorage.setItem("currency", cur);
  updatePrices();
}

/* ==============================
   Checkout Form + Messages
============================== */
function updateCheckoutPlaceholders(){
  const name = document.getElementById("name");
  const email = document.getElementById("email");
  const phone = document.getElementById("phone");
  const address = document.getElementById("address");
  if(name) name.placeholder = t('name');
  if(email) email.placeholder = t('email');
  if(phone) phone.placeholder = t('phone');
  if(address) address.placeholder = t('address');
}

function initCheckoutForm(){
  const form = document.getElementById("checkoutForm");
  if(!form) return;

  form.onsubmit = e => {
    e.preventDefault();
    const cart = getCart();
    if(!cart.length){ alert("Cart is empty"); return; }

    const cartItems = cart.map(item => `${item.name} (x${item.quantity}) - ${item.price}`);

    const params = {
      name: document.getElementById("name")?.value || "",
      email: document.getElementById("email")?.value || "",
      phone: document.getElementById("phone")?.value || "",
      address: document.getElementById("address")?.value || "",
      paymentMethod: document.getElementById("paymentMethod")?.value || "",
      orderDetails: cartItems.join("\n"),
      total: document.getElementById("cartTotal")?.innerText || ""
    };

    emailjs.send("service_kh6j2jr", "template_Orcr14j", params)
      .then(()=>{
        form.reset();
        localStorage.removeItem("cartItems");
        updateCart();
        const ok = document.getElementById("successMessage");
        if(ok){ ok.classList.remove("hidden"); setTimeout(()=>ok.classList.add("hidden"), 6000); }
      })
      .catch(err=>{
        console.error("EmailJS Error:", err);
        const bad = document.getElementById("errorMessage");
        if(bad){ bad.classList.remove("hidden"); setTimeout(()=>bad.classList.add("hidden"), 6000); }
      });
  };
}

// Reusable toast
function showMessage(type){
  const el = document.getElementById(type === "success" ? "successMessage" : "errorMessage");
  if(!el) return;
  el.classList.add("show");
  setTimeout(()=>{
    el.classList.remove("show");
    setTimeout(()=>{ el.style.display = "none"; }, 400);
  }, 5000);
}

/* ==============================
   Global Init (single block)
============================== */
document.addEventListener("DOMContentLoaded", ()=>{
  // Language selector
  const langSel = document.getElementById("language");
  if(langSel){
    langSel.value = currentLanguage;
    langSel.onchange = e => setLanguage(e.target.value);
  }

  // Currency selector
  const curSel = document.getElementById("currency");
  if(curSel){
    curSel.value = currentCurrency;
    curSel.onchange = e => setCurrency(e.target.value);
  }

  // Category filter
  const catSel = document.getElementById("categoryFilter");
  if(catSel){
    catSel.onchange = e => renderProducts(e.target.value, adminMode);
  }

  // Add-to-cart buttons (static)
  document.querySelectorAll("[data-add-to-cart]").forEach(btn=>{
    btn.onclick = () => {
      const id = btn.dataset.id;
      const name = btn.dataset.name;
      const price = parseFloat(btn.dataset.price || "0");
      addToCart(id, name, price);
    };
  });

  // Init UI
  setLanguage(currentLanguage);      // also calls populateCategories etc.
  updateCheckoutPlaceholders();
  updateReviewPlaceholders();
  renderSiteReviews();

  // Cart + checkout
  updateCart();
  updatePrices();
  initCheckoutForm();

  // Products
  fetchProducts();

  // Hide checkout if empty
  const checkoutForm = document.getElementById("checkoutForm");
  if(checkoutForm && !getCart().length) checkoutForm.classList.add("hidden");
});
</script>

</body>
</html>
